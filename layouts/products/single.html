{{ define "main" }}
<div class="relative flex h-auto min-h-screen w-full flex-col overflow-x-hidden pb-24">
<!-- Top Navigation -->
<nav class="sticky top-0 z-50 flex items-center justify-between bg-background-light/95 dark:bg-background-dark/95 backdrop-blur-sm p-4 px-6 transition-all duration-300">
<button onclick="window.history.back()" class="flex size-10 items-center justify-center rounded-full bg-transparent hover:bg-black/5 dark:hover:bg-white/10 transition-colors">
<span aria-hidden="true" class="material-symbols-outlined text-2xl">arrow_back</span>
</button>
<div class="flex items-center gap-2">
<button class="flex size-10 items-center justify-center rounded-full bg-transparent hover:bg-black/5 dark:hover:bg-white/10 transition-colors relative">
<span aria-hidden="true" class="material-symbols-outlined text-2xl">shopping_bag</span>
<!-- Badge -->
<span class="absolute top-2 right-2 h-2 w-2 rounded-full bg-primary ring-2 ring-background-light dark:ring-background-dark"></span>
</button>
</div>
</nav>
<!-- Main Product Section -->
<main class="flex flex-col gap-8">
<!-- Product Images Container -->
<div class="flex flex-col gap-4">
<!-- Hero Image -->
<div class="w-full px-4 md:px-6">
<div class="relative aspect-[4/5] w-full overflow-hidden rounded-xl bg-neutral-200 dark:bg-neutral-800 shadow-sm">
<div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 hover:scale-105" style="background-image: url('{{ index .Params.images 0 | absURL }}');">
</div>
</div>
</div>
<!-- Thumbnail Gallery -->
<div class="flex w-full overflow-x-auto no-scrollbar px-4 md:px-6 pb-2">
<div class="flex gap-3">
{{ range $index, $image := .Params.images }}
{{ if eq $index 0 }}
<button class="thumbnail group relative h-20 w-20 flex-shrink-0 overflow-hidden rounded-lg border-2 border-primary ring-offset-2 ring-offset-background-light dark:ring-offset-background-dark" data-image="{{ $image | absURL }}">
<div class="h-full w-full bg-cover bg-center opacity-100" style="background-image: url('{{ $image | absURL }}');"></div>
</button>
{{ else }}
<button class="thumbnail group relative h-20 w-20 flex-shrink-0 overflow-hidden rounded-lg border-2 border-transparent hover:border-black/10 dark:hover:border-white/10" data-image="{{ $image | absURL }}">
<div class="h-full w-full bg-cover bg-center transition-opacity" style="background-image: url('{{ $image | absURL }}');"></div>
</button>
{{ end }}
{{ end }}
</div>
</div>
</div>
<!-- Product Details -->
<div class="px-6 flex flex-col gap-6">
<!-- Header Info -->
<div class="space-y-2">
<div class="flex items-start justify-between gap-4">
<h1 class="text-3xl font-bold leading-tight tracking-tight text-soft-black dark:text-white">{{ .Title }}</h1>
</div>
{{ $price := "" }}
{{ if .Params.actualPrice }}
  {{ $price = .Params.actualPrice }}
{{ else if (and .Params.variants (gt (len .Params.variants) 0)) }}
  {{ with index .Params.variants 0 }}
    {{ if .actualPrice }}
      {{ $price = .actualPrice }}
    {{ end }}
  {{ end }}
{{ end }}
{{ if $price }}
<div class="flex items-center gap-3">
{{ if .Params.comparePrice }}
<span class="text-lg text-neutral-500 line-through">{{ .Params.comparePrice | replaceRE `^[^\d]+` "$" }}</span>
{{ end }}
<p class="text-2xl font-semibold text-soft-black dark:text-neutral-100">{{ $price | replaceRE `^[^\d]+` "$" }}</p>
{{ if not .Params.inStock }}
<span class="text-lg font-bold text-red-600">— Agotado</span>
{{ end }}
</div>
{{ end }}

<!-- Product Options/Variants -->
{{ if .Params.options }}
<div class="space-y-3">
{{ range $index, $element := .Params.options }}
<div class="flex flex-col gap-2">
<label class="text-sm font-medium text-neutral-700 dark:text-neutral-300">{{ $index | humanize }}</label>
<select class="select-{{ $index }} px-3 py-2 border border-neutral-300 dark:border-neutral-700 rounded-lg bg-white dark:bg-neutral-800 text-neutral-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-primary">
{{ range $element }}
<option>{{ . }}</option>
{{ end }}
</select>
</div>
{{ end }}
</div>
{{ end }}
</div>
<!-- Description -->
<div class="space-y-3">
<h3 class="text-sm font-bold uppercase tracking-wider text-neutral-500 dark:text-neutral-400">Descripción</h3>
<p class="text-base leading-loose text-neutral-700 dark:text-neutral-300">
{{ .Content }}
</p>
</div>
<!-- Attributes / Specs (Optional Mini Grid) -->
<div class="grid grid-cols-2 gap-4 py-2">
<div class="rounded-lg bg-white p-4 dark:bg-white/5 border border-neutral-100 dark:border-neutral-800">
<span class="block text-xs text-neutral-500 dark:text-neutral-400 mb-1">Material</span>
<span class="block font-medium">Oro reciclado 14k</span>
</div>
<div class="rounded-lg bg-white p-4 dark:bg-white/5 border border-neutral-100 dark:border-neutral-800">
<span class="block text-xs text-neutral-500 dark:text-neutral-400 mb-1">Largo de cadena</span>
<span class="block font-medium">18-20 pulgadas</span>
</div>
</div>
<!-- Primary Action -->
{{ $hasPrice := false }}
{{ $productPrice := "" }}
{{ if .Params.actualPrice }}
  {{ $hasPrice = true }}
  {{ $productPrice = .Params.actualPrice }}
{{ else if (and .Params.variants (gt (len .Params.variants) 0)) }}
  {{ with index .Params.variants 0 }}
    {{ if .actualPrice }}
      {{ $hasPrice = true }}
      {{ $productPrice = .actualPrice }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if $hasPrice }}
<div class="pt-4">
{{ $mpActive := and .Site.Params.payments.mercadopago .Params.mp_link }}
{{ $waActive := .Site.Params.payments.whatsapp }}
{{ $mpLink := .Params.mp_link }}
{{ $activeCount := 0 }}
{{ if $mpActive }}{{ $activeCount = add $activeCount 1 }}{{ end }}
{{ if $waActive }}{{ $activeCount = add $activeCount 1 }}{{ end }}

{{ if eq $activeCount 1 }}
  {{/* Solo un método activo - ir directamente */}}
  {{ if $mpActive }}
  <a href="{{ $mpLink }}" class="w-full h-14 bg-primary hover:bg-[#d9a710] active:scale-[0.98] transition-all rounded-lg flex items-center justify-center gap-2 text-soft-black font-bold text-lg shadow-sm">
    <span class="material-symbols-outlined">shopping_cart</span>
    Comprar
  </a>
  {{ else if $waActive }}
  <a href="https://wa.me/5491234567890?text=Hola!%20Me%20interesa%20comprar%20{{ .Title | urlquery }}%20por%20{{ $productPrice | replaceRE `^[^\d]+` "$" | urlquery }}" class="w-full h-14 bg-primary hover:bg-[#d9a710] active:scale-[0.98] transition-all rounded-lg flex items-center justify-center gap-2 text-soft-black font-bold text-lg shadow-sm">
    <span class="material-symbols-outlined">shopping_cart</span>
    Comprar
  </a>
  {{ end }}
{{ else if gt $activeCount 1 }}
  {{/* Múltiples métodos - abrir drawer */}}
  <button onclick="togglePaymentDrawer()" class="w-full h-14 bg-primary hover:bg-[#d9a710] active:scale-[0.98] transition-all rounded-lg flex items-center justify-center gap-2 text-soft-black font-bold text-lg shadow-sm">
    <span class="material-symbols-outlined">shopping_cart</span>
    Comprar
  </button>
{{ end }}
</div>
{{ end }}
</div>
{{ $currentCategory := index .Params.categories 0 }}
{{ $related := slice }}
{{ range where .Site.RegularPages ".Type" "products" }}
{{ if and (ne .Permalink $.Permalink) (in .Params.categories $currentCategory) }}
{{ $related = $related | append . }}
{{ end }}
{{ end }}
{{ if $related }}
<div class="h-[1px] w-full bg-neutral-200 dark:bg-neutral-800 my-2"></div>
<!-- Related Products -->
<div class="px-6 flex flex-col gap-6 pb-8">
<div class="flex items-center justify-between">
<h2 class="text-xl font-bold text-soft-black dark:text-white">También te podría gustar</h2>
<a class="text-sm font-medium text-primary hover:underline" href="/products">Ver todo</a>
</div>
<div class="grid grid-cols-2 gap-x-4 gap-y-8">
{{ range $index, $page := first 4 $related }}
<div class="group flex flex-col gap-3 cursor-pointer">
<a href="{{ $page.Permalink }}" class="flex flex-col gap-3">
<div class="w-full aspect-[3/4] overflow-hidden rounded-lg bg-neutral-100 dark:bg-neutral-800 relative">
<div class="h-full w-full bg-cover bg-center transition-transform duration-500 group-hover:scale-110" style="background-image: url('{{ $page.Params.thumbnailImage | absURL }}');"></div>
<div class="absolute top-2 right-2 rounded-full bg-white/80 dark:bg-black/50 p-1.5 opacity-0 group-hover:opacity-100 transition-opacity">
<span class="material-symbols-outlined text-sm block">favorite</span>
</div>
</div>
<div class="flex flex-col gap-1">
<h3 class="font-bold text-soft-black dark:text-white truncate">{{ $page.Title }}</h3>
<p class="text-sm text-neutral-600 dark:text-neutral-400">{{ with index $page.Params.variants 0 }}{{ .actualPrice | replaceRE `^[^\d]+` "$" }}{{ end }}</p>
</div>
</a>
</div>
{{ end }}
</div>
</div>
{{ end }}
</main>

<!-- Payment Methods Overlay -->
<div onclick="closePaymentDrawer()" class="fixed inset-0 bg-black/50 backdrop-blur-sm opacity-0 transition-opacity z-40 hidden" id="payment-overlay"></div>

<!-- Payment Modal for Desktop -->
<div class="fixed inset-0 z-50 flex items-center justify-center opacity-0 scale-95 transition-all transform hidden" id="payment-modal">
  <div class="relative bg-background-light dark:bg-background-dark rounded-2xl p-8 mx-4 max-w-md w-full">
    <div class="text-center">
      <h3 class="text-xl font-bold text-soft-black dark:text-white mb-6">Elegí cómo querés pagar</h3>

      <div class="space-y-4">
        {{ $mpActive := .Site.Params.payments.mercadopago }}
        {{ $waActive := .Site.Params.payments.whatsapp }}
        {{ $mpLink := .Params.mp_link }}

        {{ if $mpActive }}
        <a href="{{ $mpLink }}" class="w-full h-14 bg-primary hover:bg-[#d9a710] active:scale-[0.98] transition-all rounded-lg flex items-center justify-center gap-2 text-soft-black font-bold text-lg shadow-sm">
          <span class="material-symbols-outlined">credit_card</span>
          Comprar con Mercado Pago
        </a>
        {{ end }}

        {{ if $waActive }}
        <a href="https://wa.me/5491234567890?text=Hola!%20Me%20interesa%20comprar%20{{ .Title | urlquery }}%20por%20{{ with index .Params.variants 0 }}{{ .actualPrice | replaceRE `^[^\d]+` "$" | urlquery }}{{ end }}" class="w-full h-14 bg-green-600 hover:bg-green-700 active:scale-[0.98] transition-all rounded-lg flex items-center justify-center gap-2 text-white font-bold text-lg shadow-sm">
          <span class="material-symbols-outlined">phone</span>
          Coordinar por WhatsApp
        </a>
        {{ end }}
      </div>

      <button onclick="closePaymentDrawer()" class="mt-6 text-neutral-500 hover:text-soft-black dark:hover:text-white transition-colors">
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Payment Bottom Sheet for Mobile -->
<div class="fixed bottom-0 left-0 right-0 bg-background-light dark:bg-background-dark rounded-t-2xl p-6 transform translate-y-full transition-transform z-50 md:hidden" id="payment-sheet">
  <div class="w-12 h-1 bg-neutral-300 dark:bg-neutral-700 rounded-full mx-auto mb-6"></div>

  <div class="text-center">
    <h3 class="text-xl font-bold text-soft-black dark:text-white mb-6">Elegí cómo querés pagar</h3>

    <div class="space-y-4">
      {{ $mpActive := .Site.Params.payments.mercadopago }}
      {{ $waActive := .Site.Params.payments.whatsapp }}
      {{ $mpLink := .Params.mp_link }}

      {{ if $mpActive }}
      <a href="{{ $mpLink }}" class="w-full h-14 bg-primary hover:bg-[#d9a710] active:scale-[0.98] transition-all rounded-lg flex items-center justify-center gap-2 text-soft-black font-bold text-lg shadow-sm">
        <span class="material-symbols-outlined">credit_card</span>
        Comprar con Mercado Pago
      </a>
      {{ end }}

      {{ if $waActive }}
      <a href="https://wa.me/5491234567890?text=Hola!%20Me%20interesa%20comprar%20{{ .Title | urlquery }}%20por%20{{ with index .Params.variants 0 }}{{ .actualPrice | replaceRE `^[^\d]+` "$" | urlquery }}{{ end }}" class="w-full h-14 bg-green-600 hover:bg-green-700 active:scale-[0.98] transition-all rounded-lg flex items-center justify-center gap-2 text-white font-bold text-lg shadow-sm">
        <span class="material-symbols-outlined">phone</span>
        Coordinar por WhatsApp
      </a>
      {{ end }}
    </div>

    <button onclick="closePaymentDrawer()" class="mt-6 text-neutral-500 hover:text-soft-black dark:hover:text-white transition-colors">
      Cancelar
    </button>
  </div>
</div>

<!-- Sticky Bottom CTA for Mobile feel (Optional based on preference, but good for UX) -->
{{ $hasPriceSticky := false }}
{{ $productPriceSticky := "" }}
{{ if .Params.actualPrice }}
  {{ $hasPriceSticky = true }}
  {{ $productPriceSticky = .Params.actualPrice }}
{{ else if (and .Params.variants (gt (len .Params.variants) 0)) }}
  {{ with index .Params.variants 0 }}
    {{ if .actualPrice }}
      {{ $hasPriceSticky = true }}
      {{ $productPriceSticky = .actualPrice }}
    {{ end }}
  {{ end }}
{{ end }}

{{ if $hasPriceSticky }}
<div class="fixed bottom-0 left-0 w-full bg-white/80 dark:bg-[#221d10]/90 backdrop-blur-md border-t border-neutral-200 dark:border-neutral-800 p-4 z-40 flex items-center gap-4">
<div class="flex flex-col">
<span class="text-xs text-neutral-500 dark:text-neutral-400">Precio total</span>
<span class="font-bold text-lg text-soft-black dark:text-white">{{ $productPriceSticky | replaceRE `^[^\d]+` "$" }}</span>
</div>
{{ $mpActive := and $.Site.Params.payments.mercadopago $.Params.mp_link }}
{{ $waActive := $.Site.Params.payments.whatsapp }}
{{ $mpLink := $.Params.mp_link }}
{{ $activeCount := 0 }}
{{ if $mpActive }}{{ $activeCount = add $activeCount 1 }}{{ end }}
{{ if $waActive }}{{ $activeCount = add $activeCount 1 }}{{ end }}

{{ if eq $activeCount 1 }}
  {{/* Solo un método activo - ir directamente */}}
  {{ if $mpActive }}
  <a href="{{ $mpLink }}" class="flex-1 h-12 bg-primary hover:bg-[#d9a710] rounded-lg text-soft-black font-bold flex items-center justify-center shadow-lg shadow-primary/20">
    Comprar
  </a>
  {{ else if $waActive }}
  <a href="https://wa.me/5491234567890?text=Hola!%20Me%20interesa%20comprar%20{{ $.Title | urlquery }}%20por%20{{ $productPriceSticky | replaceRE `^[^\d]+` "$" | urlquery }}" class="flex-1 h-12 bg-primary hover:bg-[#d9a710] rounded-lg text-soft-black font-bold flex items-center justify-center shadow-lg shadow-primary/20">
    Comprar
  </a>
  {{ end }}
{{ else if gt $activeCount 1 }}
  {{/* Múltiples métodos - abrir drawer */}}
  <button onclick="togglePaymentDrawer()" class="flex-1 h-12 bg-primary hover:bg-[#d9a710] rounded-lg text-soft-black font-bold flex items-center justify-center shadow-lg shadow-primary/20">
    Comprar
  </button>
{{ end }}
</div>
{{ end }}
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const heroImage = document.querySelector('.aspect-\\[4\\/5\\]');
    const thumbnails = document.querySelectorAll('.thumbnail');

    thumbnails.forEach((thumbnail) => {
        thumbnail.addEventListener('click', function() {
            const imageUrl = this.getAttribute('data-image');

            // Update hero image
            heroImage.querySelector('div').style.backgroundImage = `url('${imageUrl}')`;

            // Update active thumbnail border
            thumbnails.forEach(btn => {
                btn.classList.remove('border-primary');
                btn.classList.add('border-transparent');
            });
            this.classList.remove('border-transparent');
            this.classList.add('border-primary');
        });
    });
});

// Función para abrir el drawer/modal de métodos de pago
function togglePaymentDrawer() {
    const overlay = document.getElementById('payment-overlay');
    const modal = document.getElementById('payment-modal');
    const sheet = document.getElementById('payment-sheet');

    // Mostrar overlay
    overlay.classList.remove('hidden');
    setTimeout(() => {
        overlay.classList.add('opacity-100');
    }, 10);

    // Mostrar modal/sheet con animación
    setTimeout(() => {
        if (window.innerWidth >= 768) {
            // Desktop: mostrar modal
            modal.classList.remove('hidden');
            modal.classList.remove('opacity-0', 'scale-95');
            modal.classList.add('opacity-100', 'scale-100');
        } else {
            // Mobile: mostrar bottom sheet
            sheet.classList.remove('translate-y-full');
            sheet.classList.add('translate-y-0');
        }
    }, 50);
}

// Función para cerrar el drawer/modal de métodos de pago
function closePaymentDrawer() {
    const overlay = document.getElementById('payment-overlay');
    const modal = document.getElementById('payment-modal');
    const sheet = document.getElementById('payment-sheet');

    // Ocultar overlay
    overlay.classList.remove('opacity-100');
    setTimeout(() => {
        overlay.classList.add('hidden');
    }, 300);

    // Ocultar modal/sheet con animación
    if (window.innerWidth >= 768) {
        modal.classList.remove('opacity-100', 'scale-100');
        modal.classList.add('opacity-0', 'scale-95');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    } else {
        sheet.classList.remove('translate-y-0');
        sheet.classList.add('translate-y-full');
    }
}
</script>

<script>
    var productVariants = [];
</script>

{{ end }}
